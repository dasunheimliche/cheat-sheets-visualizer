---
title: "2.16 - Modelos de Headers en FastAPI"
description: "C√≥mo agrupar y validar cabeceras HTTP usando Pydantic"
tags: ["fastapi", "headers", "pydantic", "validation"]
---

¬°Hola! Vamos a ver una funcionalidad genial de FastAPI (disponible desde la versi√≥n `0.115.0`) que te har√° la vida mucho m√°s f√°cil si trabajas con muchas cabeceras HTTP.

Imagina que tienes que pedirle al cliente (el navegador o app que llama a tu API) que te env√≠e 5 cabeceras distintas (`user-token`, `device-id`, `platform`, etc.). Declararlas una por una en la funci√≥n es tedioso y ensucia tu c√≥digo. Aqu√≠ es donde entran los **Modelos Pydantic**.

## A - Modelos Pydantic para Headers: "La Caja de Herramientas" [üî¥]

#### 1. **Introducci√≥n:**

En lugar de pedir las cabeceras "sueltas" una por una en los argumentos de tu funci√≥n, creas una clase (un modelo Pydantic) que las agrupe todas. FastAPI se encargar√° de buscar cada una en la petici√≥n y entreg√°rtelas empaquetadas en un objeto limpio.

#### 2. **Ejemplo:**

```python
from typing import Annotated
from fastapi import FastAPI, Header
from pydantic import BaseModel

app = FastAPI()

# 1. Definimos "la caja" con todas las cabeceras que esperamos
class CommonHeaders(BaseModel):
    host: str
    save_data: bool
    if_modified_since: str | None = None
    traceparent: str | None = None
    x_tag: list[str] = []

@app.get("/items/")
# 2. Usamos el modelo dentro de Annotated con Header()
async def read_items(headers: Annotated[CommonHeaders, Header()]):
    # Aqu√≠ 'headers' ya es un objeto con todos los datos listos
    return headers
```

**Explicaci√≥n del ejemplo:**
En lugar de escribir `host: str = Header(), save_data: bool = Header()...` dentro de `read_items`, definimos todo eso en la clase `CommonHeaders`. Luego, le decimos a FastAPI: "Oye, espera un par√°metro llamado `headers` que cumpla con el modelo `CommonHeaders`, y b√∫scalo en los `Header()` de la petici√≥n HTTP".

#### 3. **Desarrollo:**

Lo brillante de esto es la **reutilizaci√≥n**. Si tienes 10 endpoints (rutas) que necesitan las mismas cabeceras de autenticaci√≥n o rastreo, no tienes que copiar y pegar los argumentos 10 veces. Solo importas tu modelo `CommonHeaders` y listo. Adem√°s, puedes a√±adir validaciones y metadatos a todas las cabeceras de una sola vez dentro del modelo.

**Nota paranoica sobre `Annotated`:**
Ver√°s que uso `Annotated[CommonHeaders, Header()]`. Aunque existen formas antiguas de hacerlo (como `headers: CommonHeaders = Header()`), la documentaci√≥n y la comunidad recomiendan encarecidamente usar `Annotated`. Es el est√°ndar moderno de Python, se lleva mejor con las herramientas de edici√≥n de c√≥digo y evita confusiones futuras. ¬°Acost√∫mbrate a √©l!

üî¥ **Fundamental**: Es la forma m√°s limpia y escalable de manejar m√∫ltiples cabeceras en aplicaciones profesionales.

---

## B - Visualizaci√≥n en la Documentaci√≥n [üîµ]

#### 1. **Introducci√≥n:**

FastAPI es tan inteligente que, aunque agrupes tus cabeceras en un modelo, √©l sabe "desempaquetarlas" para mostrarlas correctamente en la documentaci√≥n autom√°tica.

#### 2. **Ejemplo:**

No necesitas c√≥digo aqu√≠, solo mira c√≥mo FastAPI genera la interfaz en `/docs`:

![Headers en Docs](https://fastapi.tiangolo.com/img/tutorial/header-param-models/image01.png)

#### 3. **Desarrollo:**

Como ves en la imagen, aunque t√∫ usaste un solo objeto `CommonHeaders` en tu c√≥digo, la documentaci√≥n muestra cada campo (`host`, `save_data`, `x_tag`, etc.) como un campo individual que el usuario puede llenar. Esto es vital para que quien consuma tu API sepa exactamente qu√© cabeceras debe enviar.

üîµ **Espec√≠fico**: Es el resultado visual de aplicar el concepto A. Bueno saber que funciona "m√°gicamente".

---

## C - Prohibir Headers Extra: "El Portero Estricto" [üîµ]

#### 1. **Introducci√≥n:**

Por defecto, si un cliente env√≠a cabeceras adicionales que no pediste, FastAPI las ignora. Pero si quieres ser estricto y lanzar un error si alguien env√≠a algo que no est√° en tu lista, puedes configurarlo en el modelo.

#### 2. **Ejemplo:**

```python
from typing import Annotated
from fastapi import FastAPI, Header
from pydantic import BaseModel

class CommonHeaders(BaseModel):
    # Esta l√≠nea m√°gica proh√≠be cualquier extra
    model_config = {"extra": "forbid"}

    host: str
    save_data: bool
    # ... resto de campos

@app.get("/items/")
async def read_items(headers: Annotated[CommonHeaders, Header()]):
    return headers
```

**Explicaci√≥n del ejemplo:**
Al a√±adir `model_config = {"extra": "forbid"}` dentro de tu clase, si alguien env√≠a una cabecera llamada `tool: plumbus` (que no definiste), recibir√° un error `422 Unprocessable Entity` diciendo "Extra inputs are not permitted".

#### 3. **Desarrollo:**

Esto es √∫til en casos de seguridad muy espec√≠ficos o protocolos r√≠gidos donde recibir basura o datos no esperados puede ser un problema.

üîµ **Espec√≠fico**: No es com√∫n usarlo en todas las APIs, pero es una herramienta poderosa cuando necesitas control total.

---

## D - Desactivar Conversi√≥n de Guiones Bajos [‚ö™]

#### 1. **Introducci√≥n:**

En HTTP, las cabeceras suelen usar guiones medios (`user-agent`), pero en Python usamos guiones bajos (`user_agent`). FastAPI convierte autom√°ticamente `_` a `-`. Si por alguna extra√±a raz√≥n necesitas que la cabecera HTTP tenga literalmente un guion bajo, debes desactivar esta ayuda.

#### 2. **Ejemplo:**

```python
# ... imports ...

class CommonHeaders(BaseModel):
    save_data: bool # FastAPI esperar√° "save-data" por defecto
    # ...

@app.get("/items/")
async def read_items(
    # Aqu√≠ desactivamos la conversi√≥n autom√°tica
    headers: Annotated[CommonHeaders, Header(convert_underscores=False)],
):
    return headers
```

**Explicaci√≥n del ejemplo:**
Al poner `convert_underscores=False`, FastAPI dejar√° de ser amable. Ahora, para el campo `save_data`, esperar√° una cabecera HTTP llamada literalmente `save_data`, y no `save-data`.

#### 3. **Desarrollo:**

**¬°Cuidado aqu√≠!** La mayor√≠a de los servidores y proxies HTTP no se llevan bien con los guiones bajos en las cabeceras. Es un est√°ndar de facto usar guiones medios. Solo usa esto si est√°s integrando con un sistema legacy muy raro o una herramienta interna espec√≠fica que viola los est√°ndares web comunes.

‚ö™ **Raramente usado**: Es una configuraci√≥n para casos borde. En el 99% de los casos, querr√°s la conversi√≥n autom√°tica activada (que es el default).
