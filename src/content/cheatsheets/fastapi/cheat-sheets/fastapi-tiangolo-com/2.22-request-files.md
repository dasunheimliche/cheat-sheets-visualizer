---
title: "2.22 - Request Files en FastAPI"
description: "Gu칤a definitiva para recibir archivos subidos por el cliente"
tags: ["fastapi", "files", "upload", "form-data"]
prompt-version: cheat-sheet-generator-1.1
---

## A - Instalaci칩n de `python-multipart` [游댮 Fundamental]

#### 1. **Introducci칩n:**

Antes de escribir una sola l칤nea de c칩digo, necesitas instalar una herramienta "traductora". FastAPI no habla el idioma de los archivos subidos por defecto, necesita ayuda.

#### 2. **Ejemplo:**

```bash
$ pip install python-multipart
```

#### 3. **Desarrollo:**

Los archivos subidos se env칤an como "form data" (datos de formulario), no como JSON. Para que FastAPI pueda recibir y entender estos datos, **es obligatorio** instalar `python-multipart`. Si olvidas esto, tu aplicaci칩n te gritar치 un error cuando intentes subir un archivo.

---

## B - Importar `File` y `UploadFile` [游댮 Fundamental]

#### 1. **Introducci칩n:**

Para manejar archivos, necesitamos importar dos herramientas espec칤ficas desde `fastapi`.

#### 2. **Ejemplo:**

```python
from typing import Annotated
from fastapi import FastAPI, File, UploadFile

app = FastAPI()
```

#### 3. **Desarrollo:**

- **`File`**: Es una funci칩n que devuelve una clase especial (hereda de `Form`). Le dice a FastAPI: "Oye, busca este par치metro en los datos del formulario, no en la URL ni en el JSON".
- **`UploadFile`**: Es el tipo de dato que usaremos para manejar el archivo de forma eficiente.

---

## C - Definir Archivos como `bytes` [游리 Importante]

#### 1. **Introducci칩n:**

La forma m치s "cruda" de recibir un archivo es pedirle a FastAPI que lea todo el contenido y te lo entregue como una secuencia de bytes.

#### 2. **Ejemplo:**

```python
@app.post("/files/")
async def create_file(file: Annotated[bytes, File()]):
    return {"file_size": len(file)}
```

**Explicaci칩n del ejemplo:**
Aqu칤 definimos el tipo del par치metro `file` como `bytes`. Usamos `File()` para indicarle a FastAPI que extraiga ese dato del formulario de subida. La funci칩n devuelve el tama침o del archivo.

#### 3. **Desarrollo:**

Al declarar el tipo como `bytes`, FastAPI lee el archivo completo y lo almacena en la memoria RAM de tu servidor.

- **Ventaja:** Es simple para archivos muy peque침os.
- **Peligro:** Si un usuario sube un video de 2GB, tu servidor intentar치 cargar esos 2GB en la memoria RAM, lo que podr칤a colapsar tu aplicaci칩n.

---

## D - Definir Archivos con `UploadFile` [游댮 Fundamental]

#### 1. **Introducci칩n:**

Esta es la forma profesional y recomendada de manejar archivos, especialmente si son grandes (im치genes, videos).

#### 2. **Ejemplo:**

```python
@app.post("/uploadfile/")
async def create_upload_file(file: UploadFile):
    return {"filename": file.filename}
```

**Explicaci칩n del ejemplo:**
En lugar de `bytes`, usamos `UploadFile` como el tipo de dato. Nota que aqu칤 no es estrictamente necesario usar `File()` en el valor por defecto (aunque puedes hacerlo para a침adir metadatos), FastAPI es lo suficientemente listo para saber que `UploadFile` implica un archivo de formulario.

#### 3. **Desarrollo:**

`UploadFile` usa un archivo "spooled" (enrollado/temporal). Esto significa que se guarda en memoria hasta cierto l칤mite de tama침o; si el archivo supera ese l칤mite, se guarda autom치ticamente en el disco duro. Esto protege tu memoria RAM.

---

## E - COMPARATIVA: `bytes` vs `UploadFile` [游댮 Fundamental]

#### 1. **Introducci칩n:**

Aqu칤 es donde debes prestar atenci칩n para no cometer errores de rendimiento. 쮺u치l elijo?

#### 2. **Tabla Comparativa:**

| Caracter칤stica      | `bytes`                                             | `UploadFile`                                             |
| :------------------ | :-------------------------------------------------- | :------------------------------------------------------- |
| **Almacenamiento**  | Todo en Memoria RAM.                                | Memoria + Disco (si es grande).                          |
| **Rendimiento**     | R치pido para archivos diminutos, fatal para grandes. | Eficiente y seguro para cualquier tama침o.                |
| **Metadatos**       | No tienes acceso al nombre original ni tipo.        | Acceso a `filename`, `content_type`, etc.                |
| **Interfaz**        | Es solo una cadena de bytes.                        | Se comporta como un archivo de Python (`read`, `write`). |
| **Uso recomendado** | Casi nunca, salvo casos muy espec칤ficos.            | **Siempre**, es la opci칩n por defecto.                   |

#### 3. **Desarrollo:**

Imagina que `bytes` es intentar memorizar un libro entero palabra por palabra (te explota la cabeza si es largo). `UploadFile` es tener el libro en la mesa: puedes leer una p치gina, cerrarlo, ver la portada (metadatos) o ir a la p치gina 50, sin tener que memorizarlo todo.

**Veredicto del Pedagogo:** Usa `UploadFile`. Te da metadatos gratis y protege tu servidor.

---

## F - Atributos de `UploadFile` [游리 Importante]

#### 1. **Introducci칩n:**

El objeto `UploadFile` viene con etiquetas informativas muy 칰tiles sobre el archivo que el usuario subi칩.

#### 2. **Ejemplo:**

```python
@app.post("/info/")
async def get_file_info(file: UploadFile):
    return {
        "nombre_original": file.filename, # Ej: "gato.jpg"
        "tipo_contenido": file.content_type # Ej: "image/jpeg"
    }
```

#### 3. **Desarrollo:**

- `filename`: Un `str` con el nombre original del archivo (ej. `mi_cv.pdf`).
- `content_type`: Un `str` con el tipo MIME (ej. `application/pdf`).
- `file`: El objeto interno de Python (`SpooledTemporaryFile`). 칔til si necesitas pasarlo a otra librer칤a que espera un objeto tipo archivo.

---

## G - M칠todos Async de `UploadFile` [游댯 Espec칤fico]

#### 1. **Introducci칩n:**

Como `UploadFile` se comporta como un archivo real, puedes leerlo o manipularlo, pero ojo: sus m칠todos son as칤ncronos (`async`).

#### 2. **Ejemplo:**

```python
contents = await file.read() # Leer todo el contenido
await file.seek(0)           # Regresar el "cursor" al inicio del archivo
await file.close()           # Cerrar el archivo
```

#### 3. **Desarrollo:**

Estos m칠todos llaman internamente a las funciones de archivo de Python, pero se ejecutan en un _threadpool_ para no bloquear tu servidor.

- `write(data)`: Escribe datos en el archivo.
- `read(size)`: Lee `size` bytes (o todo si no especificas).
- `seek(offset)`: Mueve el cursor de lectura a la posici칩n `offset`. Muy 칰til si le칤ste el archivo y necesitas leerlo de nuevo (haces `seek(0)`).
- `close()`: Cierra el archivo.

**춰Cuidado!** Como son m칠todos `async`, **siempre** debes usar la palabra clave `await` antes de llamarlos.

---

## H - 쯈u칠 es "Form Data"? [游댯 Espec칤fico]

#### 1. **Introducci칩n:**

Es el formato de codificaci칩n que usan los formularios HTML cuando env칤an archivos.

#### 2. **Desarrollo:**

Normalmente, las APIs modernas usan JSON (`application/json`). Pero JSON no es bueno para enviar archivos binarios.

- Formularios simples: Usan `application/x-www-form-urlencoded`.
- Formularios con archivos: Usan `multipart/form-data`.

FastAPI detecta autom치ticamente cuando usas `File` y sabe que debe leer el cuerpo de la petici칩n como `multipart/form-data`.

---

## I - La Regla de Oro: No mezclar `Body` (JSON) con `File` [游댮 Fundamental]

#### 1. **Introducci칩n:**

Esta es una trampa com칰n. No puedes esperar recibir un JSON puro y un archivo en el mismo nivel de la petici칩n.

#### 2. **Explicaci칩n:**

Debido a c칩mo funciona el protocolo HTTP:

- O tu cuerpo es JSON (`application/json`).
- O tu cuerpo es Form Data (`multipart/form-data`).

No pueden ser ambos a la vez.

**La Trampa:**

```python
# ESTO DAR츼 PROBLEMAS SI ESPERAS JSON PURO EN 'data'
async def bad_example(file: UploadFile, data: Item = Body(...)):
    ...
```

Si declaras un `File`, todo el cuerpo se codifica como `multipart`. Si necesitas enviar datos extra junto con el archivo, esos datos deben enviarse como campos de formulario (`Form`), no como JSON (`Body`).

---

## J - Archivos Opcionales [游리 Importante]

#### 1. **Introducci칩n:**

A veces el usuario puede enviar un archivo o no. Debemos manejar esa posibilidad.

#### 2. **Ejemplo:**

```python
@app.post("/uploadfile/")
async def create_upload_file(file: UploadFile | None = None):
    if not file:
        return {"message": "No enviaste archivo"}
    return {"filename": file.filename}
```

#### 3. **Desarrollo:**

Simplemente define el tipo como `UploadFile | None` (o `Union[UploadFile, None]` en versiones viejas de Python) y asigna `= None` como valor por defecto. As칤 FastAPI no lanzar치 error si el campo falta.

---

## K - Metadatos y Validaci칩n con `File()` [游댯 Espec칤fico]

#### 1. **Introducci칩n:**

Puedes usar `File()` junto con `UploadFile` para a침adir descripciones o validaciones extra, igual que har칤as con `Query` o `Path`.

#### 2. **Ejemplo:**

```python
async def create_file(
    file: Annotated[UploadFile, File(description="Un archivo de audio")]
):
    ...
```

#### 3. **Desarrollo:**

Esto no cambia el comportamiento del archivo, pero ayuda a la documentaci칩n autom치tica (Swagger UI) y permite configuraciones adicionales.

---

## L - Subida de M칰ltiples Archivos [游리 Importante]

#### 1. **Introducci칩n:**

Para permitir que el usuario seleccione y suba varios archivos a la vez en el mismo campo.

#### 2. **Ejemplo:**

```python
@app.post("/uploadfiles/")
async def create_upload_files(files: list[UploadFile]):
    return {"filenames": [file.filename for file in files]}
```

**HTML del cliente:**

```html
<input name="files" type="file" multiple />
```

#### 3. **Desarrollo:**

Solo necesitas declarar el tipo como una lista: `list[UploadFile]` (o `List[UploadFile]`). FastAPI entender치 que debe esperar uno o m치s archivos asociados al mismo nombre de campo y te los entregar치 en una lista de Python lista para iterar.
