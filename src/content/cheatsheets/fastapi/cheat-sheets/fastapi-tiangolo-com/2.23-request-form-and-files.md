---
title: "2.23 - Request Forms and Files en FastAPI"
description: "C√≥mo recibir archivos y datos de formulario simult√°neamente"
tags: ["fastapi", "files", "forms", "multipart"]
---

## A - Instalaci√≥n de `python-multipart`: El Motor Oculto [üî¥]

#### 1. **Introducci√≥n:**

Antes de escribir una sola l√≠nea de c√≥digo, necesitas instalar una herramienta espec√≠fica, ya que FastAPI no procesa formularios complejos por s√≠ solo.

#### 2. **Ejemplo:**

```bash
$ pip install python-multipart
```

#### 3. **Desarrollo:**

**üî¥ Fundamental:** Sin esta librer√≠a, tu aplicaci√≥n lanzar√° un error al intentar recibir archivos o formularios. FastAPI delega el trabajo pesado de procesar los datos "multipart" (partes m√∫ltiples) a esta librer√≠a. Aseg√∫rate de tener tu entorno virtual activado antes de instalarlo.

---

## B - Importaci√≥n de Componentes: Las Herramientas Necesarias [üî¥]

#### 1. **Introducci√≥n:**

Para mezclar archivos y datos de texto, necesitas importar expl√≠citamente `File` y `Form` (y `UploadFile` si quieres manejo avanzado de archivos).

#### 2. **Ejemplo:**

```python
from typing import Annotated
from fastapi import FastAPI, File, Form, UploadFile # <--- Aqu√≠ est√°n los protagonistas
```

#### 3. **Desarrollo:**

**üî¥ Fundamental:** No puedes usar `File` o `Form` si no los traes desde `fastapi`. Nota que estamos usando `Annotated` (desde `typing`), que es la forma moderna y recomendada de definir estos par√°metros en las versiones recientes de Python y FastAPI.

---

## C - Definici√≥n Mixta: Archivos y Datos a la vez [üî¥]

#### 1. **Introducci√≥n:**

Puedes definir par√°metros de archivo (`File`) y par√°metros de texto (`Form`) en la misma funci√≥n; FastAPI entender√° que todo viene en el mismo paquete de datos.

#### 2. **Ejemplo:**

```python
@app.post("/files/")
async def create_file(
    # Un archivo le√≠do como bytes puros
    file: Annotated[bytes, File()],
    # Un archivo con metadatos y m√©todos (m√°s eficiente)
    fileb: Annotated[UploadFile, File()],
    # Un campo de texto normal del formulario
    token: Annotated[str, Form()],
):
    return {
        "file_size": len(file),
        "token": token,
        "fileb_content_type": fileb.content_type,
    }
```

**Explicaci√≥n del ejemplo:**
Aqu√≠ ocurre la magia. `file` y `fileb` esperan archivos, mientras que `token` espera un simple texto (string). Al usar `File()` y `Form()`, le dices a FastAPI c√≥mo buscar cada dato dentro de la petici√≥n que llega.

#### 3. **Desarrollo:**

**üî¥ Fundamental:** Esta estructura permite que el cliente (quien usa tu API) env√≠e un formulario "multipart/form-data". FastAPI extraer√° los archivos para las variables definidas con `File()` y los campos de texto para las definidas con `Form()`.

---

## D - `bytes` vs `UploadFile`: Dos formas de recibir archivos [üü°]

#### 1. **Introducci√≥n:**

En el ejemplo anterior vimos que puedes declarar archivos de dos formas distintas en la misma petici√≥n.

#### 2. **Ejemplo:**

```python
# Opci√≥n A: Todo el archivo en memoria (bytes)
file: Annotated[bytes, File()]

# Opci√≥n B: Manejo inteligente (UploadFile)
fileb: Annotated[UploadFile, File()]
```

#### 3. **Desarrollo:**

**üü° Importante:** El texto nos muestra que es posible mezclar ambos tipos.

- **`bytes`**: FastAPI lee el archivo entero y lo guarda en memoria. √ötil para archivos muy peque√±os.
- **`UploadFile`**: Es m√°s robusto, tiene metadatos (como `content_type`) y maneja mejor archivos grandes.
- **La clave**: Puedes tener un par√°metro esperando `bytes` y otro esperando `UploadFile` en la misma funci√≥n sin problemas.

---

## E - La Trampa del JSON: `Body` vs `Form` [üü°]

#### 1. **Introducci√≥n:**

**¬°Cuidado aqu√≠!** No puedes esperar recibir un JSON (`Body`) y datos de Formulario (`Form`/`File`) al mismo tiempo.

#### 2. **Ejemplo:**

```python
# ‚ùå ESTO DAR√Å ERROR O COMPORTAMIENTO INESPERADO
async def bad_example(
    file: Annotated[bytes, File()],
    data: Annotated[dict, Body()] # <--- ¬°No puedes mezclar Body (JSON) con File!
):
    pass
```

#### 3. **Desarrollo:**

**üü° Importante:** Esto no es culpa de FastAPI, es una regla del protocolo HTTP.

- Una petici√≥n HTTP tiene una forma de codificarse (`Content-Type`).
- O es `application/json` (para `Body`).
- O es `multipart/form-data` (para `File` y `Form`).
- **No pueden ser las dos a la vez.**

Si usas `File` o `Form`, toda la petici√≥n se codifica como `multipart/form-data`. Por lo tanto, si necesitas enviar datos extra junto con un archivo, **debes** usar `Form`, no `Body`.
