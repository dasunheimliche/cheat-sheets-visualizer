---
title: "2.20 - Form Data en FastAPI"
description: "C√≥mo recibir datos de formularios HTML cl√°sicos en lugar de JSON"
tags: ["fastapi", "forms", "python", "http"]
prompt-version: cheat-sheet-generator-1.1
---

## A - Instalaci√≥n de `python-multipart`: El Motor Oculto [üî¥]

#### 1. **Introducci√≥n:**

Antes de escribir una sola l√≠nea de c√≥digo, necesitas instalar una librer√≠a extra, ya que FastAPI no procesa formularios por s√≠ solo; necesita este "motor" auxiliar.

#### 2. **Ejemplo:**

```bash
# En tu terminal, con tu entorno virtual activo:
pip install python-multipart
```

**Explicaci√≥n del ejemplo:**
Este comando descarga la herramienta que FastAPI usar√° internamente para "desempaquetar" los datos que vienen de un formulario. Si olvidas esto, tu aplicaci√≥n te dar√° un error al intentar recibir un formulario.

#### 3. **Desarrollo:**

FastAPI es muy ligero y no incluye todo por defecto. Para leer datos de formularios (que t√©cnicamente vienen codificados de una forma especial), delega el trabajo sucio a `python-multipart`.
**¬°Ojo!** No necesitas importar `python-multipart` en tu archivo `.py`, solo necesitas tenerlo instalado en tu entorno. FastAPI lo detectar√° y usar√° autom√°ticamente.

üî¥ **Fundamental**: Sin esta instalaci√≥n, nada de lo que sigue funcionar√°. Es el error n√∫mero 1 de los principiantes.

---

## B - Importar y Usar `Form`: Recibiendo los Datos [üî¥]

#### 1. **Introducci√≥n:**

Para recibir datos de un formulario (como un login), debes usar `Form` en tus par√°metros, lo cual le indica a FastAPI que busque los datos en los campos del formulario y no en un JSON.

#### 2. **Ejemplo:**

```python
from typing import Annotated
from fastapi import FastAPI, Form # <--- Importamos Form

app = FastAPI()

@app.post("/login/")
# Usamos Form() para decirle a FastAPI de d√≥nde sacar el dato
async def login(username: Annotated[str, Form()], password: Annotated[str, Form()]):
    return {"username": username}
```

**Explicaci√≥n del ejemplo:**
Aqu√≠ definimos una ruta `/login/`. Al usar `Annotated[str, Form()]`, le estamos gritando a FastAPI: _"¬°Espera! No busques un JSON. Busca un campo llamado 'username' dentro de los datos del formulario HTML"_.

#### 3. **Desarrollo:**

Es vital entender que si **no** usas `Form()`, FastAPI intentar√° interpretar esos par√°metros como "Query Parameters" (los que van en la URL) o como un cuerpo JSON. Debes ser expl√≠cito.
El ejemplo cl√°sico es el flujo de contrase√±as de OAuth2, que _exige_ enviar `username` y `password` como campos de formulario, no como JSON.

üî¥ **Fundamental**: Es la pieza central para que tu API pueda interactuar con formularios HTML est√°ndar (`<form>`).

---

## C - Sintaxis `Annotated` vs Cl√°sica: La Forma Moderna [üü°]

#### 1. **Introducci√≥n:**

Existen dos formas de escribir el c√≥digo anterior; aunque ambas funcionan, se prefiere fuertemente la versi√≥n con `Annotated`.

#### 2. **Ejemplo:**

```python
# OPCI√ìN A (Recomendada - Python 3.9+):
username: Annotated[str, Form()]

# OPCI√ìN B (Cl√°sica / Antigua):
username: str = Form()
```

**Explicaci√≥n del ejemplo:**
La Opci√≥n A usa `Annotated` (una caracter√≠stica moderna de Python) para separar el tipo de dato (`str`) de la instrucci√≥n a FastAPI (`Form()`). La Opci√≥n B asigna `Form()` como valor por defecto.

#### 3. **Desarrollo:**

Aunque ver√°s la Opci√≥n B en muchos tutoriales antiguos, la documentaci√≥n oficial y las buenas pr√°cticas actuales sugieren usar `Annotated`. Esto ayuda a que otras herramientas y editores de c√≥digo entiendan mejor lo que est√°s haciendo. Sin embargo, si usas una versi√≥n de Python anterior a la 3.9, podr√≠as necesitar importar `Annotated` desde `typing_extensions`.

üü° **Importante**: Usa `Annotated` siempre que sea posible para mantener tu c√≥digo moderno y compatible con el futuro.

---

## D - Codificaci√≥n de Datos: `x-www-form-urlencoded` vs JSON [üîµ]

#### 1. **Introducci√≥n:**

Los formularios HTML no hablan "JSON"; hablan un "idioma" diferente llamado `application/x-www-form-urlencoded`, y FastAPI se encarga de traducir esto por ti.

#### 2. **Ejemplo:**

- **JSON (Lo habitual):** `{"username": "pepe", "password": "123"}`
- **Form Data (Lo que vemos hoy):** `username=pepe&password=123`

#### 3. **Desarrollo:**

Aqu√≠ es donde quiero que hagas "click".
Cuando usas `Body` (o nada), FastAPI espera JSON.
Cuando usas `Form`, FastAPI espera esa cadena de texto especial (`clave=valor&otra=cosa`) que los navegadores env√≠an por defecto en los formularios HTML.
FastAPI lee esa codificaci√≥n "especial" y te entrega los datos limpios en tus variables.

**Nota t√©cnica:** Si el formulario incluye archivos, la codificaci√≥n cambia a `multipart/form-data`, pero eso lo veremos cuando hablemos de subir archivos.

üîµ **Espec√≠fico**: Es crucial entender esto para saber por qu√© no puedes probar estos endpoints enviando un JSON crudo desde Postman o ThunderClient; debes seleccionar la opci√≥n "Form" o "x-www-form-urlencoded".

---

## E - Validaci√≥n y Metadatos: La Herencia de `Body` [üîµ]

#### 1. **Introducci√≥n:**

`Form` es en realidad un "hijo" de la clase `Body`, lo que significa que tiene todos sus superpoderes: validaci√≥n, alias, ejemplos, etc.

#### 2. **Ejemplo:**

```python
# Podemos a√±adir validaciones igual que en Body o Query
username: Annotated[str, Form(min_length=3, alias="user-name")]
```

**Explicaci√≥n del ejemplo:**
Aunque sea un formulario, puedes exigir que el `username` tenga m√≠nimo 3 caracteres o que en el formulario HTML el campo se llame `user-name` pero en tu c√≥digo Python se llame `username`.

#### 3. **Desarrollo:**

No pierdes funcionalidad por usar `Form`. Todo lo que aprendiste sobre validaci√≥n de datos con `Body`, `Query` o `Path` se aplica exactamente igual aqu√≠.

üîµ **Espec√≠fico**: √ötil cuando necesitas formularios robustos y seguros, no solo recibir texto plano.

---

## F - La Trampa de la Mezcla: JSON y Form No Conviven [üî¥]

#### 1. **Introducci√≥n:**

No puedes declarar par√°metros `Form` y par√°metros `Body` (JSON) en la misma petici√≥n; debes elegir uno u otro.

#### 2. **Ejemplo:**

```python
# ‚ùå ESTO DAR√Å ERROR O COMPORTAMIENTO INESPERADO
@app.post("/error/")
async def mix(
    user_data: UserJSON = Body(),  # Espera application/json
    form_field: str = Form()       # Espera application/x-www-form-urlencoded
):
    pass
```

#### 3. **Desarrollo:**

Esto no es culpa de FastAPI, es una regla del protocolo HTTP. Una petici√≥n (request) tiene un solo "Content-Type".

- O todo el cuerpo viene codificado como formulario (`application/x-www-form-urlencoded`).
- O todo el cuerpo viene como JSON (`application/json`).

Si declaras un `Form`, todo el cuerpo se tratar√° como formulario. Si intentas forzar un JSON ah√≠, FastAPI se confundir√°.

üî¥ **Fundamental**: Evita horas de depuraci√≥n. Si usas `Form`, olv√≠date de recibir JSON en esa misma ruta espec√≠fica.
