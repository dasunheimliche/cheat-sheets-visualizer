---
title: "2.17 - FastAPI: Response Models y Filtrado de Datos"
description: "C칩mo controlar, validar y asegurar los datos que tu API env칤a al cliente."
tags: ["fastapi", "pydantic", "security", "response"]
prompt-version: cheat-sheet-generator-1.1
---

## A - Return Type Annotation: "Dici칠ndole a Python qu칠 sale" [游댮]

#### 1. **Introducci칩n:**

Es la forma est치ndar de Python de indicar qu칠 tipo de dato va a devolver tu funci칩n, usando la "flechita" `->` despu칠s de los par칠ntesis.

#### 2. **Ejemplo:**

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

# F칤jate en el "-> Item" y en el "-> list[Item]"
@app.post("/items/")
async def create_item(item: Item) -> Item:
    return item

@app.get("/items/")
async def read_items() -> list[Item]:
    return [
        Item(name="Portal Gun", price=42.0),
        Item(name="Plumbus", price=32.0),
    ]
```

**Explicaci칩n del ejemplo:**
En `create_item`, le decimos a Python (y a FastAPI) que devolveremos un objeto `Item`. En `read_items`, le decimos que devolveremos una lista de objetos `Item`.

#### 3. **Desarrollo:**

FastAPI usa esta informaci칩n para tres cosas vitales:

1.  **Validar**: Si tu c칩digo devuelve algo que no encaja (le falta un campo obligatorio), FastAPI lanzar치 un error de servidor en lugar de enviar datos basura al cliente.
2.  **Documentar**: Genera autom치ticamente el esquema JSON en la documentaci칩n interactiva.
3.  **Filtrar**: (Lo m치s importante) Limita los datos de salida solo a lo que definiste en el modelo.

游댮 **Fundamental**: Es la base de c칩mo FastAPI garantiza que tu API sea predecible y segura.

---

## B - El par치metro `response_model`: "El Jefe del Decorador" [游댮]

#### 1. **Introducci칩n:**

Es un par치metro que se pone dentro del decorador (`@app.get(...)`) para decirle a FastAPI expl칤citamente qu칠 modelo usar para la respuesta, independientemente de lo que diga la funci칩n.

#### 2. **Ejemplo:**

```python
from typing import Any

# Aqu칤 usamos response_model dentro del decorador
@app.post("/items/", response_model=Item)
async def create_item(item: Item) -> Any:
    return item
```

**Explicaci칩n del ejemplo:**
Aunque la funci칩n dice que devuelve `Any` (cualquier cosa), FastAPI forzar치 que la respuesta se valide y filtre usando el modelo `Item` porque as칤 se lo indicamos en `response_model=Item`.

#### 3. **Desarrollo:**

쯇or qu칠 usar esto si ya tenemos la "flechita" del concepto A? A veces quieres devolver un diccionario, una base de datos o un objeto complejo, pero quieres que FastAPI lo convierta y valide como un modelo Pydantic antes de enviarlo. Si usaras la flechita `-> Item` devolviendo un diccionario, tu editor de c칩digo (VS Code, PyCharm) te gritar칤a un error, pero con `response_model` todos son felices.

游댮 **Fundamental**: Necesario cuando el tipo de dato que manipulas dentro de la funci칩n no es exactamente igual a la clase del modelo que quieres enviar al usuario.

---

## C - Comparaci칩n: `response_model` vs. Return Type [游리]

#### 1. **Introducci칩n:**

쮺u치l gana si usas los dos? El `response_model` siempre tiene prioridad sobre la anotaci칩n de la funci칩n.

#### 2. **Ejemplo:**

```python
# El editor cree que devuelves un dict (correcto para el c칩digo interno)
# FastAPI sabe que debe salir un UserOut (correcto para la API)
@app.get("/user", response_model=UserOut)
async def get_user() -> dict:
    return {"username": "admin", "password": "123"} # Devuelves un dict
```

#### 3. **Desarrollo:**

Aqu칤 est치 la "trampa" que confunde a muchos:

- **Return Type (`->`)**: Es principalmente para tu **editor de c칩digo** y herramientas como `mypy`. Les ayuda a autocompletar y detectar errores mientras programas.
- **`response_model`**: Es para **FastAPI**. Le dice c칩mo procesar, filtrar y documentar los datos antes de enviarlos por internet.

**쮺u치l elegir?**

- Usa **ambos** si puedes.
- Si tienes que elegir prioridad para la l칩gica de la API, **`response_model` manda**.
- Si quieres desactivar la validaci칩n de FastAPI pero mantener el tipado para tu editor, usa `response_model=None`.

游리 **Importante**: Entender esta diferencia evita peleas con el linter de tu editor.

---

## D - El Peligro de Seguridad: "Devolver lo que entra" [游댮]

#### 1. **Introducci칩n:**

Si usas el mismo modelo para recibir datos (input) y para enviarlos (output), puedes filtrar accidentalmente informaci칩n sensible como contrase침as.

#### 2. **Ejemplo:**

```python
class UserIn(BaseModel):
    username: str
    password: str # 丘멆잺 춰Peligro!
    email: str

@app.post("/user/")
async def create_user(user: UserIn) -> UserIn:
    return user # 丘멆잺 Est치s devolviendo la contrase침a al cliente
```

#### 3. **Desarrollo:**

Si un usuario se registra, y t칰 le devuelves el objeto `user` tal cual, le estar치s enviando de vuelta su contrase침a en texto plano. Esto es una p칠sima pr치ctica de seguridad. Nunca conf칤es en que "el cliente ya sabe su contrase침a".

游댮 **Fundamental**: Jam치s expongas campos sensibles en la respuesta de la API.

---

## E - La Soluci칩n: Output Models (Modelos de Salida) [游댮]

#### 1. **Introducci칩n:**

La regla de oro es crear un modelo para recibir datos (con contrase침a) y OTRO modelo diferente para responder (sin contrase침a).

#### 2. **Ejemplo:**

```python
# Modelo para recibir datos (Input)
class UserIn(BaseModel):
    username: str
    password: str
    email: str

# Modelo para responder (Output) - 춰Sin password!
class UserOut(BaseModel):
    username: str
    email: str

@app.post("/user/", response_model=UserOut)
async def create_user(user: UserIn) -> Any:
    return user
```

**Explicaci칩n del ejemplo:**
Aunque la funci칩n `return user` devuelve el objeto completo (que tiene password), como definimos `response_model=UserOut`, FastAPI **filtra** autom치ticamente el campo `password` porque no existe en `UserOut`. El cliente recibe solo username y email.

游댮 **Fundamental**: Es el patr칩n de dise침o est치ndar en FastAPI para seguridad y limpieza de datos.

---

## F - Herencia de Clases: "Lo mejor de dos mundos" [游댯]

#### 1. **Introducci칩n:**

Podemos usar herencia de clases de Python para tener autocompletado en el editor Y filtrado de seguridad en FastAPI al mismo tiempo.

#### 2. **Ejemplo:**

```python
class BaseUser(BaseModel):
    username: str
    email: str

class UserIn(BaseUser): # Hereda de BaseUser
    password: str

# Anotamos que devolvemos BaseUser, pero en realidad devolvemos UserIn
@app.post("/user/")
async def create_user(user: UserIn) -> BaseUser:
    return user
```

#### 3. **Desarrollo:**

- **Para el editor:** Como `UserIn` es hijo de `BaseUser`, devolver `user` es v치lido. El editor est치 feliz.
- **Para FastAPI:** Ve que el tipo de retorno declarado es `BaseUser`. Toma el objeto `UserIn`, y recorta todo lo que no pertenezca a `BaseUser` (adi칩s password).

游댯 **Espec칤fico**: Es una t칠cnica elegante para mantener el c칩digo limpio y tipado correctamente sin duplicar campos.

---

## G - Visualizaci칩n en la Documentaci칩n [游댯]

#### 1. **Introducci칩n:**

FastAPI es tan inteligente que mostrar치 esquemas JSON diferentes para la entrada y la salida en la documentaci칩n autom치tica.

#### 2. **Ejemplo:**

Ver치s algo as칤 en tus docs:

- **Input**: JSON con password.
- **Output**: JSON sin password.

![Esquemas JSON en Docs](https://fastapi.tiangolo.com/img/tutorial/response-model/image01.png)
![Documentaci칩n Interactiva](https://fastapi.tiangolo.com/img/tutorial/response-model/image02.png)

#### 3. **Desarrollo:**

Esto ayuda a quien consuma tu API (frontend devs, otros servicios) a saber exactamente qu칠 deben enviar y qu칠 recibir치n, sin ambig칲edades.

游댯 **Espec칤fico**: No tienes que configurar nada, sucede autom치ticamente al usar modelos distintos.

---

## H - Retornar `Response` Directamente [游리]

#### 1. **Introducci칩n:**

A veces no quieres devolver un JSON de un modelo, sino una redirecci칩n o una respuesta HTTP personalizada.

#### 2. **Ejemplo:**

```python
from fastapi import Response
from fastapi.responses import RedirectResponse

@app.get("/portal")
async def get_portal(teleport: bool = False) -> Response:
    if teleport:
        return RedirectResponse(url="https://www.youtube.com/watch?v=dQw4w9WgXcQ")
    return {"message": "Aqu칤 no hay portal"} # Esto fallar칤a si la anotaci칩n fuera estricta
```

#### 3. **Desarrollo:**

Si anotas el retorno como `Response` (o una subclase como `RedirectResponse`), FastAPI entiende que no debe intentar validarlo con Pydantic, sino enviarlo tal cual.
**Ojo:** Si intentas devolver un diccionario cuando prometiste un `Response`, o usas una uni칩n rara como `Response | dict`, FastAPI puede confundirse y fallar si no desactivas el response model.

游리 **Importante**: 칔til para redirecciones, descargas de archivos o headers personalizados.

---

## I - Desactivar el Response Model [游댯]

#### 1. **Introducci칩n:**

Si quieres mantener tus anotaciones de tipo para el editor, pero no quieres que FastAPI valide ni filtre nada en la salida.

#### 2. **Ejemplo:**

```python
@app.get("/portal", response_model=None)
async def get_portal() -> Response | dict:
    return {"message": "Libre soy"}
```

#### 3. **Desarrollo:**

Al poner `response_model=None`, le dices a FastAPI: "No generes documentaci칩n ni validaci칩n para la salida de esta ruta, conf칤a en m칤". Esto permite retornar uniones de tipos que Pydantic no soportar칤a f치cilmente.

游댯 **Espec칤fico**: Para casos avanzados donde la flexibilidad supera a la validaci칩n estricta.

---

## J - `response_model_exclude_unset`: "Limpiando los nulos" [游리]

#### 1. **Introducci칩n:**

Sirve para no enviar campos que tienen valores por defecto y que no fueron modificados. Evita respuestas JSON gigantes llenas de `null` o valores vac칤os.

#### 2. **Ejemplo:**

```python
class Item(BaseModel):
    name: str
    description: str | None = None # Default es None
    tags: list[str] = []           # Default es lista vac칤a

items = {"foo": {"name": "Foo"}}

@app.get("/items/{item_id}", response_model=Item, response_model_exclude_unset=True)
async def read_item(item_id: str):
    return items[item_id]
```

**Salida JSON:**

```json
{ "name": "Foo" }
```

_(Nota que `description` y `tags` no se env칤an porque no se tocaron y tienen defaults)_.

#### 3. **Desarrollo:**

- Si el dato tiene el valor por defecto (ej. `tags=[]`), pero t칰 lo asignaste expl칤citamente, **S칈** se env칤a.
- Solo se excluye si el campo **no se estableci칩** en absoluto al crear el modelo.
- Tambi칠n existen `response_model_exclude_defaults=True` (excluye todo lo que sea igual al default) y `response_model_exclude_none=True` (excluye todo lo que sea null).

游리 **Importante**: Muy 칰til para bases de datos NoSQL o APIs que quieren ahorrar ancho de banda.

---

## K - Filtrado R치pido: `include` y `exclude` [游댯]

#### 1. **Introducci칩n:**

Son atajos en el decorador para incluir o excluir campos espec칤ficos sin crear un modelo nuevo, aunque tienen una desventaja en la documentaci칩n.

#### 2. **Ejemplo:**

```python
@app.get("/items/", response_model=Item, response_model_exclude={"tax"})
async def read_items():
    return items
```

**Explicaci칩n del ejemplo:**
Devolver치 el `Item` completo PERO quitar치 el campo `tax`. Puedes usar `set` (`{"tax"}`) o `list` (`["tax"]`).

#### 3. **Desarrollo:**

**La trampa:** Aunque la API real no env칤e el campo `tax`, **la documentaci칩n autom치tica (Swagger) seguir치 mostrando el modelo completo** (con `tax`). Por eso, se recomienda usar el m칠todo de **Output Models (Concepto E)** si quieres que la documentaci칩n sea precisa. Usa esto solo para prototipos r치pidos o cuando la documentaci칩n exacta no es cr칤tica.

游댯 **Espec칤fico**: 칔til para "parches" r치pidos, pero menos robusto que crear clases dedicadas.
