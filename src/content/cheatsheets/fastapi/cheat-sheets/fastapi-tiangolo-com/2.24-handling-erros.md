---
title: "2.24 - Manejo de Errores en FastAPI"
description: "Gu铆a completa sobre c贸mo reportar problemas al cliente, excepciones y validaciones."
tags: ["fastapi", "errors", "exceptions", "http"]
---

## A - C贸digos de Estado HTTP: La se帽al de tr谩fico[]

#### 1. **Introducci贸n:**

Antes de programar, debes saber que los c贸digos **400-499** significan "Culpa del Cliente" (ej: olvid贸 un dato), mientras que los **200-299** son "xito".

#### 2. **Ejemplo:**

- **200 OK**: "Aqu铆 tienes tu usuario".
- **404 Not Found**: "El usuario que buscas no existe" (Error del cliente por pedir algo imaginario).
- **401 Unauthorized**: "No tienes permiso" (Error del cliente por no identificarse).

#### 3. **Desarrollo:**

Imagina que eres un bibliotecario. Si alguien te pide un libro y se lo das, es un **200**. Si te piden un libro que no existe en el cat谩logo, t煤 no te rompes (no es un error del servidor 500), simplemente les informas que ellos cometieron un error al buscar. Eso es un error de rango **400**.

[] [Fundamental]: Sin entender esto, no puedes construir una API RESTful correcta. Es el lenguaje universal de la web.

## B - `HTTPException`: Tu meg谩fono de errores[]

#### 1. **Introducci贸n:**

Es la clase especial de FastAPI para detener todo y enviar un error HTTP formateado al cliente.

#### 2. **Ejemplo:**

```python
from fastapi import FastAPI, HTTPException

app = FastAPI()
items = {"foo": "The Foo Wrestlers"}

@app.get("/items/{item_id}")
async def read_item(item_id: str):
    if item_id not in items:
        # 隆ALTO! Detenemos todo y enviamos un 404
        raise HTTPException(status_code=404, detail="Item not found")
    return {"item": items[item_id]}
```

#### 3. **Desarrollo:**

`HTTPException` lleva dos cosas vitales:

1.  `status_code`: El n煤mero del error (ej. 404).
2.  `detail`: La explicaci贸n para el humano (o m谩quina) que lee el error.

[] [Fundamental]: Es la forma est谩ndar y correcta de decir "algo sali贸 mal" en FastAPI.

## C - `raise` vs `return`: El freno de emergencia[]

#### 1. **Introducci贸n:**

Las excepciones se **lanzan** (`raise`), no se retornan (`return`), para cortar la ejecuci贸n inmediatamente, incluso desde funciones anidadas.

#### 2. **Ejemplo:**

```python
# CORRECTO:
if error:
    raise HTTPException(status_code=404, detail="Error")
    # El c贸digo aqu铆 abajo JAMS se ejecutar谩.

# INCORRECTO (No hagas esto con excepciones):
if error:
    return HTTPException(status_code=404, detail="Error")
    # Esto solo devolver铆a el objeto excepci贸n como si fuera un dato JSON normal.
```

#### 3. **Desarrollo:**

Piensa en `raise` como tirar del freno de emergencia de un tren. No importa si est谩s en el vag贸n comedor (una funci贸n auxiliar) o en la cabina (la funci贸n principal), el tren se detiene al instante y nadie m谩s trabaja. Si usaras `return`, solo le estar铆as pasando el objeto de error a la funci贸n anterior, y el tren seguir铆a avanzando, probablemente causando un desastre mayor.

[] [Fundamental]: Confundir esto es el error #1 de principiantes en Python/FastAPI.

## D - `detail` flexible: M谩s que solo texto[]

#### 1. **Introducci贸n:**

El par谩metro `detail` no tiene que ser solo un string; puedes pasar listas o diccionarios y FastAPI los convertir谩 a JSON autom谩ticamente.

#### 2. **Ejemplo:**

```python
raise HTTPException(
    status_code=404,
    detail={"error_code": 1020, "message": "Item perdido", "sugerencia": "Busca otro"}
)
```

**Respuesta JSON que recibe el cliente:**

```json
{
  "detail": {
    "error_code": 1020,
    "message": "Item perdido",
    "sugerencia": "Busca otro"
  }
}
```

#### 3. **Desarrollo:**

Esto es util铆simo cuando tu frontend (React, Vue, etc.) necesita c贸digos de error espec铆ficos para saber qu茅 pantallita mostrar, m谩s all谩 de un simple mensaje de texto.

[] [Importante]: Da flexibilidad profesional a tu API.

## E - Headers Personalizados en Errores[]

#### 1. **Introducci贸n:**

A veces, por seguridad o protocolo, necesitas enviar informaci贸n extra en las cabeceras (headers) de la respuesta de error.

#### 2. **Ejemplo:**

```python
raise HTTPException(
    status_code=404,
    detail="No encontrado",
    headers={"X-Error-Type": "InputError"} # Header personalizado
)
```

#### 3. **Desarrollo:**

Probablemente no lo uses a diario, pero es vital para escenarios avanzados de seguridad (como indicar tipos de autenticaci贸n requerida).

[] [Espec铆fico]: Solo lo usar谩s si tienes requisitos muy puntuales de arquitectura o seguridad.

## F - `@app.exception_handler`: El Cazafantasmas Global[]

#### 1. **Introducci贸n:**

Te permite definir una funci贸n que se ejecutar谩 autom谩ticamente cada vez que ocurra una excepci贸n espec铆fica en **cualquier** parte de tu c贸digo.

#### 2. **Ejemplo:**

```python
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse

class UnicornException(Exception):
    def __init__(self, name: str):
        self.name = name

app = FastAPI()

# Aqu铆 "atrapamos" la excepci贸n personalizada
@app.exception_handler(UnicornException)
async def unicorn_exception_handler(request: Request, exc: UnicornException):
    return JSONResponse(
        status_code=418,
        content={"message": f"隆Oops! {exc.name} tuvo problemas."},
    )

@app.get("/unicorns/{name}")
async def read_unicorn(name: str):
    if name == "yolo":
        raise UnicornException(name=name) # Lanzamos la excepci贸n propia
    return {"unicorn_name": name}
```

#### 3. **Desarrollo:**

En lugar de llenar tu c贸digo de `try-except`, defines un "manejador" (handler) en un solo lugar. Si alguien lanza `UnicornException`, FastAPI busca al manejador registrado y deja que 茅l responda.

[] [Importante]: Mantiene tu c贸digo limpio y centraliza la l贸gica de errores.

## G - Sobrescribir `RequestValidationError`[]

#### 1. **Introducci贸n:**

FastAPI valida los datos autom谩ticamente. Si quieres cambiar el mensaje de error por defecto que recibe el cliente cuando env铆a datos mal, sobrescribe este manejador.

#### 2. **Ejemplo:**

```python
from fastapi.exceptions import RequestValidationError
from fastapi.responses import PlainTextResponse

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request, exc):
    # En lugar de un JSON complejo, devolvemos texto plano
    return PlainTextResponse(str(exc), status_code=400)
```

#### 3. **Desarrollo:**

Por defecto, FastAPI devuelve un JSON muy detallado con `loc`, `msg`, `type`. Si prefieres algo m谩s simple o en otro idioma, aqu铆 es donde lo cambias.

[] [Espec铆fico]: til si tu empresa tiene un formato de error est谩ndar estricto.

## H - `RequestValidationError` vs `ValidationError` (La Trampa)[]

#### 1. **Introducci贸n:**

`RequestValidationError` es para datos malos del **cliente**. `ValidationError` (de Pydantic) en la respuesta es un **bug tuyo**.

#### 2. **Ejemplo:**

- **Cliente env铆a "cinco" en un campo num茅rico:** Se lanza `RequestValidationError`. El cliente recibe un 422. (Correcto).
- **Tu c贸digo intenta devolver un string en un campo que definiste como `int`:** Se lanza `ValidationError`. El cliente recibe un 500 Internal Server Error. (Correcto, porque es culpa tuya, no del cliente).

#### 3. **Desarrollo:**

FastAPI oculta los detalles del `ValidationError` de salida (response) por seguridad. No quieres que un usuario externo vea las tripas de tu c贸digo o estructura interna solo porque cometiste un error al programar.

[] [Importante]: Entender esto te ayuda a saber d贸nde buscar el error (en el request del cliente o en tu l贸gica de respuesta).

## I - Acceso al `body` en errores de validaci贸n[]

#### 1. **Introducci贸n:**

Cuando falla la validaci贸n, el objeto de excepci贸n contiene el `body` (cuerpo) original que envi贸 el cliente, lo cual es genial para logs o depuraci贸n.

#### 2. **Ejemplo:**

```python
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=422,
        content={"detail": exc.errors(), "body_recibido": exc.body}, # <--- Aqu铆 accedemos al body
    )
```

#### 3. **Desarrollo:**

Permite decirle al usuario: "Fallaste. Me enviaste ESTO, y est谩 mal por ESTA raz贸n".

[] [Espec铆fico]: Muy 煤til en desarrollo o para logs de auditor铆a.

## J - FastAPI `HTTPException` vs Starlette `HTTPException`[]

#### 1. **Introducci贸n:**

Aqu铆 hay una posible confusi贸n. FastAPI usa su propia `HTTPException` para permitir detalles JSON, pero hereda de Starlette.

#### 2. **Comparaci贸n y Uso:**

| Herramienta       | `fastapi.HTTPException`                         | `starlette.exceptions.HTTPException`                                    |
| :---------------- | :---------------------------------------------- | :---------------------------------------------------------------------- |
| **Uso Principal** | **Para LANZAR (`raise`)** errores en tu c贸digo. | **Para CAPTURAR (`@app.exception_handler`)** errores.                   |
| **Ventaja**       | Permite `detail` como dict/list (JSON).         | Es la clase base. Captura errores de FastAPI y de plugins de Starlette. |

#### 3. **Ejemplo de la "Trampa" a evitar:**

```python
from fastapi import HTTPException # Para usar en el c贸digo
from starlette.exceptions import HTTPException as StarletteHTTPException # Para el handler

# CORRECTO: Capturamos la de Starlette para atrapar TODO
@app.exception_handler(StarletteHTTPException)
async def http_exception_handler(request, exc):
    return PlainTextResponse(str(exc.detail), status_code=exc.status_code)

# EN TU CDIGO:
@app.get("/items/{id}")
def read_item(id: int):
    # Usamos la de FastAPI para poder mandar detalles ricos si queremos
    raise HTTPException(status_code=404, detail="Nope")
```

#### 4. **Desarrollo:**

Si registras el handler solo para la excepci贸n de FastAPI, podr铆as perderte errores lanzados por partes internas de Starlette (la librer铆a sobre la que se construye FastAPI). Al registrar el handler para `StarletteHTTPException`, cubres ambas bases porque la de FastAPI es una "hija" de la de Starlette.

[] [Importante]: Es un detalle t茅cnico sutil pero importante para tener un manejo de errores robusto que no deje escapar nada.

## K - Reutilizar Manejadores de Excepciones[]

#### 1. **Introducci贸n:**

Puedes "interceptar" un error, hacer algo (como un log), y luego dejar que FastAPI lo maneje como siempre.

#### 2. **Ejemplo:**

```python
from fastapi.exception_handlers import http_exception_handler as default_handler

@app.exception_handler(StarletteHTTPException)
async def custom_handler(request, exc):
    print(f"隆ALERTA! Error ocurrido: {exc}") # 1. Hacemos lo nuestro (Log)
    return await default_handler(request, exc) # 2. Llamamos al original
```

#### 3. **Desarrollo:**

No necesitas reescribir toda la l贸gica de respuesta JSON si solo quieres a帽adir un `print` o guardar el error en una base de datos antes de responder.

[] [Espec铆fico]: Excelente para a帽adir logging sin romper el comportamiento est谩ndar de la API.
